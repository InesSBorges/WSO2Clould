<?xml version="1.0" encoding="UTF-8"?>
<sequence name="seq_validateUserLanguage" trace="disable" xmlns="http://ws.apache.org/ns/synapse">
    <!-- Validação do valor de $ctx:userLanguage antes do dblookup -->
    <filter regex="true" source="string-length($ctx:userLanguage) = 0 or $ctx:userLanguage = '&lt;userLanguage/>' or $ctx:userLanguage = '&lt;userLanguage>&lt;/userLanguage>'">
        <then>
            <property name="userLanguage" scope="default" type="STRING" value=""/>
        </then>
        <else/>
    </filter>
    <!-- Verificação de $ctx:operationUser -->
    <filter regex="true" source="string-length($ctx:operationUser) > 0">
        <then>
            <dblookup>
                <connection>
                    <pool>
                        <dsName>ds_sqlserver_CRUDSustIMS30</dsName>
                    </pool>
                </connection>
                <statement>
                    <sql><![CDATA[
		            	DECLARE @result VARCHAR(100), 
		                       @resutCode VARCHAR(100), 
		                       @message VARCHAR(100), 
		                       @status INT, 
		                       @languageOut VARCHAR(100)
		            	
		                EXEC ADM.ValidateUserLanguage ?, ?, 
		                     @result OUTPUT, 
		                     @resutCode OUTPUT, 
		                     @message OUTPUT, 
		                     @status OUTPUT, 
		                     @languageOut OUTPUT;
		                     
		                SELECT @result AS result, 
		                       @resutCode AS resutCode, 
		                       @message AS message, 
		                       @status AS status, 
		                       @languageOut AS languageOut;
		            ]]></sql>
                    <parameter expression="$ctx:operationUser" type="VARCHAR"/>
                    <parameter expression="$ctx:userLanguage" type="VARCHAR"/>
                    <result column="result" name="result"/>
                    <result column="resutCode" name="resutCode"/>
                    <result column="message" name="message"/>
                    <result column="status" name="status"/>
                    <result column="languageOut" name="languageOut"/>
                </statement>
            </dblookup>
            <!-- Validação do resultado -->
            <filter regex="true" source="$ctx:result = 1">
                <then>
                    <property expression="$ctx:languageOut" name="validUserLanguage" scope="default" type="STRING"/>
                </then>
                <else>
                    <property expression="$ctx:resutCode" name="validResultCode" scope="default" type="STRING"/>
                    <property expression="$ctx:status" name="validStatus" scope="default" type="STRING"/>
                    <property expression="$ctx:message" name="validMessage" scope="default" type="STRING"/>
                    <sequence key="seq_messageOutput"/>
                    <sequence key="seq_resultOutput"/>
                </else>
            </filter>
        </then>
        <else>
            <propertyGroup>
                <property name="validResultCode" scope="default" type="STRING" value="SustIMS0439"/>
                <property name="validStatus" scope="default" type="STRING" value="400"/>
                <property name="validMessage" scope="default" type="STRING" value="Bad Request"/>
            </propertyGroup>
            <sequence key="seq_messageOutput"/>
            <propertyGroup>
                <property expression="concat($ctx:validMessageDescription, ' (operationUser)')" name="validMessageDescription" scope="default" type="STRING"/>
                <property expression="concat($ctx:validClientMessageDescription, ' (operationUser)')" name="validClientMessageDescription" scope="default" type="STRING"/>
            </propertyGroup>
            <sequence key="seq_resultOutput"/>
        </else>
    </filter>
</sequence>
